<!-- 
–û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –†–ï–§–ï–†–ê–õ–¨–ù–´–• –°–°–´–õ–û–ö
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –µ–≥–æ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ
-->

<script>
(function() {
    'use strict';
    
    const SERVER_URL = 'https://tilda-supabase-server-nodejs-20.up.railway.app';
    
    console.log('üîó –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫...');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –±—Ä–∞—É–∑–µ—Ä–∞
    function getBrowserId() {
        let id = localStorage.getItem('tilda_browser_id');
        if (!id) {
            id = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('tilda_browser_id', id);
            console.log('üÜî –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Browser ID:', id);
        }
        return id;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const params = {};
        
        for (const [key, value] of urlParams.entries()) {
            params[key] = value;
        }
        
        return params;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function saveReferralInfo() {
        const params = getUrlParams();
        const browserId = getBrowserId();
        
        // –ò—â–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
        const referralCode = params.ref || params.referral || params.r || params.refcode;
        
        if (referralCode) {
            const referralInfo = {
                referral_code: referralCode,
                source_url: window.location.href,
                landing_page: window.location.pathname,
                timestamp: new Date().toISOString(),
                browser_id: browserId,
                user_agent: navigator.userAgent,
                utm_source: params.utm_source || null,
                utm_medium: params.utm_medium || null,
                utm_campaign: params.utm_campaign || null
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('tilda_referral_info', JSON.stringify(referralInfo));
            localStorage.setItem('tilda_referral_code', referralCode);
            localStorage.setItem('tilda_referral_timestamp', new Date().toISOString());
            
            console.log('üéØ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', referralInfo);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            sendReferralTracking(referralInfo);
        } else {
            console.log('‚ÑπÔ∏è –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ URL –Ω–µ –Ω–∞–π–¥–µ–Ω');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            const savedReferral = localStorage.getItem('tilda_referral_info');
            if (savedReferral) {
                console.log('üìã –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:', JSON.parse(savedReferral));
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
    async function sendReferralTracking(referralInfo) {
        try {
            const response = await fetch(`${SERVER_URL}/track-referral`, {
                method: 'POST',
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'referral_visit',
                    ...referralInfo
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:', error);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
    function getReferralInfoForPurchase() {
        const savedReferral = localStorage.getItem('tilda_referral_info');
        const referralCode = localStorage.getItem('tilda_referral_code');
        
        if (savedReferral) {
            return JSON.parse(savedReferral);
        } else if (referralCode) {
            return {
                referral_code: referralCode,
                timestamp: localStorage.getItem('tilda_referral_timestamp'),
                browser_id: getBrowserId()
            };
        }
        
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Ñ–æ—Ä–º –ø–æ–∫—É–ø–∫–∏
    function interceptPurchaseForms() {
        console.log('üí≥ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç —Ñ–æ—Ä–º –ø–æ–∫—É–ø–∫–∏...');
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ñ–æ—Ä–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const forms = document.querySelectorAll('form');
        
        forms.forEach((form, index) => {
            // –ò—â–µ–º —Ñ–æ—Ä–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ñ–æ—Ä–º–∞–º–∏ –ø–æ–∫—É–ø–∫–∏
            const hasPaymentFields = form.querySelector('input[name*="price"], input[name*="amount"], input[name*="sum"], input[name*="payment"], button[type="submit"]');
            
            if (hasPaymentFields) {
                console.log(`üí≥ –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∫—É–ø–∫–∏ ${index + 1}:`, form);
                
                form.addEventListener('submit', function(event) {
                    console.log('üí≥ –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ–∫—É–ø–∫–∏:', form);
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                    const referralInfo = getReferralInfoForPurchase();
                    
                    if (referralInfo) {
                        console.log('üéØ –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –ø–æ–∫—É–ø–∫–µ:', referralInfo);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                        addHiddenFieldsToForm(form, referralInfo);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∫–µ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
                        sendPurchaseWithReferral(form, referralInfo);
                    } else {
                        console.log('‚ÑπÔ∏è –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–π –ø–æ–∫—É–ø–∫–∏');
                    }
                });
            }
        });
        
        // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const newForms = node.tagName === 'FORM' ? [node] : (node.querySelectorAll ? node.querySelectorAll('form') : []);
                        
                        newForms.forEach(function(newForm) {
                            const hasPaymentFields = newForm.querySelector('input[name*="price"], input[name*="amount"], input[name*="sum"], input[name*="payment"], button[type="submit"]');
                            
                            if (hasPaymentFields) {
                                console.log('üí≥ –ù–∞–π–¥–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ –ø–æ–∫—É–ø–∫–∏:', newForm);
                                
                                newForm.addEventListener('submit', function(event) {
                                    const referralInfo = getReferralInfoForPurchase();
                                    
                                    if (referralInfo) {
                                        console.log('üéØ –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–æ–∫—É–ø–∫–µ:', referralInfo);
                                        addHiddenFieldsToForm(newForm, referralInfo);
                                        sendPurchaseWithReferral(newForm, referralInfo);
                                    }
                                });
                            }
                        });
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π –≤ —Ñ–æ—Ä–º—É
    function addHiddenFieldsToForm(form, referralInfo) {
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingFields = form.querySelectorAll('input[name^="referral_"]');
        existingFields.forEach(field => field.remove());
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        const fieldsToAdd = {
            'referral_code': referralInfo.referral_code,
            'referral_browser_id': referralInfo.browser_id,
            'referral_timestamp': referralInfo.timestamp,
            'referral_source_url': referralInfo.source_url || '',
            'referral_landing_page': referralInfo.landing_page || ''
        };
        
        Object.keys(fieldsToAdd).forEach(fieldName => {
            if (fieldsToAdd[fieldName]) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = fieldName;
                hiddenField.value = fieldsToAdd[fieldName];
                form.appendChild(hiddenField);
                
                console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ: ${fieldName} = ${fieldsToAdd[fieldName]}`);
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—É–ø–∫–µ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
    async function sendPurchaseWithReferral(form, referralInfo) {
        try {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            const formData = new FormData(form);
            const formObject = {};
            
            for (const [key, value] of formData.entries()) {
                formObject[key] = value;
            }
            
            const purchaseData = {
                action: 'purchase_with_referral',
                form_data: formObject,
                referral_info: referralInfo,
                page_url: window.location.href,
                timestamp: new Date().toISOString(),
                browser_id: getBrowserId()
            };
            
            console.log('üí≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º:', purchaseData);
            
            const response = await fetch(`${SERVER_URL}/purchase-with-referral`, {
                method: 'POST',
                mode: 'cors',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(purchaseData)
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', data);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–∫–∏ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º:', error);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function cleanupOldReferralInfo() {
        const referralTimestamp = localStorage.getItem('tilda_referral_timestamp');
        
        if (referralTimestamp) {
            const referralTime = new Date(referralTimestamp);
            const now = new Date();
            const daysDiff = (now - referralTime) / (1000 * 60 * 60 * 24);
            
            // –û—á–∏—â–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
            if (daysDiff > 30) {
                localStorage.removeItem('tilda_referral_info');
                localStorage.removeItem('tilda_referral_code');
                localStorage.removeItem('tilda_referral_timestamp');
                console.log('üßπ –û—á–∏—â–µ–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
            }
        }
    }
    
    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    function init() {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤...');
        
        // –û—á–∏—â–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        cleanupOldReferralInfo();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ URL
        saveReferralInfo();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç —Ñ–æ—Ä–º –ø–æ–∫—É–ø–∫–∏
        interceptPurchaseForms();
        
        console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∞–∫—Ç–∏–≤–Ω–∞');
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    window.TildaReferralTracker = {
        getReferralInfo: getReferralInfoForPurchase,
        addReferralToForm: function(form) {
            const referralInfo = getReferralInfoForPurchase();
            if (referralInfo) {
                addHiddenFieldsToForm(form, referralInfo);
            }
            return referralInfo;
        }
    };
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    console.log('üìã –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
})();
</script>