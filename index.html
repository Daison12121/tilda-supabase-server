<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç Browser ID System - AIDA.KG</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px;
            margin: 0 auto;
            background: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            border-left: 4px solid #007bff;
            max-height: 400px;
            overflow-y: auto;
        }
        .browser-id {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        .success {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        input[type="email"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            margin-right: 10px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        .info-box {
            background: #e2e3e5;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ –¢–µ—Å—Ç Browser ID System</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –¥–ª—è AIDA.KG</p>
        <div>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞: <span id="serverStatus" class="status offline">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span></div>
    </div>
    
    <div class="test-section">
        <h3>üÜî –í–∞—à Browser ID:</h3>
        <div id="browserIdDisplay" class="browser-id">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
        <div class="info-box">
            <strong>–ß—Ç–æ —ç—Ç–æ:</strong> –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞. –ö–∞–∂–¥—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari) –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π ID.
        </div>
    </div>
    
    <div class="test-section">
        <h3>1. üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <div>
            <input type="email" id="testEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ email" value="numisushi@gmail.com">
            <button onclick="testAuth()" id="authBtn">üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
        </div>
        <div id="authResult" class="result" style="display: none;"></div>
        <div class="info-box">
            <strong>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –≤–∞—à–∏–º Browser ID.
        </div>
    </div>
    
    <div class="test-section">
        <h3>2. üë§ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <button onclick="testUserData()" id="userBtn">üë§ –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <div id="userResult" class="result" style="display: none;"></div>
        <div class="info-box">
            <strong>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong> –°–µ—Ä–≤–µ—Ä –∏—â–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –≤–∞—à–µ–º—É Browser ID.
        </div>
    </div>
    
    <div class="test-section">
        <h3>3. üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Browser Sessions</h3>
        <button onclick="testBrowserSessions()" id="sessionsBtn">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏–∏</button>
        <div id="sessionsResult" class="result" style="display: none;"></div>
        <div class="info-box">
            <strong>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong> –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏ —Å–≤—è–∑—å Browser ID ‚Üí Email.
        </div>
    </div>

    <div class="test-section">
        <h3>4. üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
        <button onclick="clearData()" style="background: #dc3545;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
        <button onclick="generateNewId()" style="background: #ffc107; color: #000;">üîÑ –ù–æ–≤—ã–π Browser ID</button>
        <div class="info-box">
            <strong>–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> –û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π ID –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://tilda-supabase-server-nodejs-20.up.railway.app';
        let browserId = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –±—Ä–∞—É–∑–µ—Ä–∞
        function getBrowserId() {
            let id = localStorage.getItem('tilda_browser_id');
            if (!id) {
                id = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('tilda_browser_id', id);
                console.log('üÜî –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Browser ID:', id);
            } else {
                console.log('üÜî –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Browser ID:', id);
            }
            return id;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
        async function checkServerStatus() {
            try {
                const response = await fetch(`${SERVER_URL}/debug-sessions`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = '–û–Ω–ª–∞–π–Ω';
                    document.getElementById('serverStatus').className = 'status online';
                    return true;
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = '–û—Ñ–ª–∞–π–Ω';
                document.getElementById('serverStatus').className = 'status offline';
                return false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            browserId = getBrowserId();
            document.getElementById('browserIdDisplay').textContent = browserId;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
            await checkServerStatus();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π email
            const storedEmail = localStorage.getItem('tilda_auth_user');
            if (storedEmail) {
                document.getElementById('testEmail').value = storedEmail;
            }
        }

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${isError ? 'error' : 'success'}`;
            
            if (typeof data === 'object') {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
        }

        async function testAuth() {
            const email = document.getElementById('testEmail').value;
            const btn = document.getElementById('authBtn');
            
            if (!email) {
                showResult('authResult', '–í–≤–µ–¥–∏—Ç–µ email!', true);
                return;
            }
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...';
                showResult('authResult', '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                
                const response = await fetch(`${SERVER_URL}/auth-sync`, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        action: 'login',
                        timestamp: new Date().toISOString(),
                        source: 'test',
                        page: window.location.href,
                        browser_id: browserId
                    })
                });
                
                const data = await response.json();
                showResult('authResult', data);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('tilda_auth_user', email);
                
            } catch (error) {
                showResult('authResult', `–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è';
            }
        }

        async function testUserData() {
            const btn = document.getElementById('userBtn');
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                showResult('userResult', '–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const storedEmail = localStorage.getItem('tilda_auth_user');
                let url = `${SERVER_URL}/user-full-data?browser_id=${browserId}`;
                if (storedEmail) {
                    url += `&email=${encodeURIComponent(storedEmail)}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                showResult('userResult', data);
                
            } catch (error) {
                showResult('userResult', `–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üë§ –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
            }
        }

        async function testBrowserSessions() {
            const btn = document.getElementById('sessionsBtn');
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
                showResult('sessionsResult', '–ü—Ä–æ–≤–µ—Ä—è–µ–º Browser Sessions...');
                
                const response = await fetch(`${SERVER_URL}/debug-sessions?browser_id=${browserId}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                showResult('sessionsResult', data);
                
            } catch (error) {
                showResult('sessionsResult', `–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Å—Å–∏–∏';
            }
        }

        function clearData() {
            localStorage.removeItem('tilda_auth_user');
            localStorage.removeItem('tilda_auth_timestamp');
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω—ã!');
        }

        function generateNewId() {
            localStorage.removeItem('tilda_browser_id');
            browserId = getBrowserId();
            document.getElementById('browserIdDisplay').textContent = browserId;
            alert('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Browser ID: ' + browserId);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        init();
    </script>
</body>
</html>