<!-- 
–†–£–ß–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò –ö –§–û–†–ú–ê–ú
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–æ—Ä–º–µ
-->

<script>
(function() {
    'use strict';
    
    console.log('üîß –ó–∞–≥—Ä—É–∂–µ–Ω —Å–∫—Ä–∏–ø—Ç —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫ —Ñ–æ—Ä–º–∞–º');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function getReferralInfo() {
        const savedReferral = localStorage.getItem('tilda_referral_info');
        const referralCode = localStorage.getItem('tilda_referral_code');
        
        if (savedReferral) {
            return JSON.parse(savedReferral);
        } else if (referralCode) {
            return {
                referral_code: referralCode,
                timestamp: localStorage.getItem('tilda_referral_timestamp'),
                browser_id: localStorage.getItem('tilda_browser_id')
            };
        }
        
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∫ —Ñ–æ—Ä–º–µ
    function addReferralFieldsToForm(form, referralInfo) {
        if (!form || !referralInfo) {
            console.warn('‚ö†Ô∏è –§–æ—Ä–º–∞ –∏–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return false;
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        const existingFields = form.querySelectorAll('input[name^="referral_"]');
        existingFields.forEach(field => field.remove());
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        const fieldsToAdd = {
            'referral_code': referralInfo.referral_code,
            'referral_browser_id': referralInfo.browser_id,
            'referral_timestamp': referralInfo.timestamp,
            'referral_source_url': referralInfo.source_url || '',
            'referral_landing_page': referralInfo.landing_page || ''
        };
        
        let addedFields = 0;
        
        Object.keys(fieldsToAdd).forEach(fieldName => {
            if (fieldsToAdd[fieldName]) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = fieldName;
                hiddenField.value = fieldsToAdd[fieldName];
                form.appendChild(hiddenField);
                
                console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ: ${fieldName} = ${fieldsToAdd[fieldName]}`);
                addedFields++;
            }
        });
        
        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedFields} —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∫ —Ñ–æ—Ä–º–µ`);
        return true;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ñ–æ—Ä–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    function processAllForms() {
        const referralInfo = getReferralInfo();
        
        if (!referralInfo) {
            console.log('‚ÑπÔ∏è –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        console.log('üîç –ò—â–µ–º —Ñ–æ—Ä–º—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...');
        console.log('üìã –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:', referralInfo);
        
        const forms = document.querySelectorAll('form');
        let processedForms = 0;
        
        forms.forEach((form, index) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–æ—Ä–º–∞ —Ñ–æ—Ä–º–æ–π –ø–æ–∫—É–ø–∫–∏/–∑–∞–∫–∞–∑–∞
            const hasPaymentFields = form.querySelector('input[name*="price"], input[name*="amount"], input[name*="sum"], input[name*="payment"], input[name*="order"], button[type="submit"]');
            
            if (hasPaymentFields) {
                console.log(`üí≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É ${index + 1}:`, form);
                
                if (addReferralFieldsToForm(form, referralInfo)) {
                    processedForms++;
                }
            }
        });
        
        console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedForms} —Ñ–æ—Ä–º –∏–∑ ${forms.length} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö`);
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    window.TildaReferralHelper = {
        // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        getReferralInfo: getReferralInfo,
        
        // –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–æ—Ä–º–µ
        addToForm: function(formSelector) {
            const form = typeof formSelector === 'string' ? document.querySelector(formSelector) : formSelector;
            const referralInfo = getReferralInfo();
            
            if (form && referralInfo) {
                return addReferralFieldsToForm(form, referralInfo);
            } else {
                console.warn('‚ö†Ô∏è –§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                return false;
            }
        },
        
        // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        processAllForms: processAllForms,
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        showReferralInfo: function() {
            const referralInfo = getReferralInfo();
            if (referralInfo) {
                console.log('üìã –¢–µ–∫—É—â–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:', referralInfo);
                alert('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ' + referralInfo.referral_code + '\n–í—Ä–µ–º—è: ' + referralInfo.timestamp);
            } else {
                console.log('‚ÑπÔ∏è –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                alert('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        },
        
        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤—Ä—É—á–Ω—É—é
        setReferralCode: function(code) {
            const referralInfo = {
                referral_code: code,
                timestamp: new Date().toISOString(),
                browser_id: localStorage.getItem('tilda_browser_id') || 'manual_' + Date.now(),
                source_url: window.location.href,
                landing_page: window.location.pathname
            };
            
            localStorage.setItem('tilda_referral_info', JSON.stringify(referralInfo));
            localStorage.setItem('tilda_referral_code', code);
            localStorage.setItem('tilda_referral_timestamp', referralInfo.timestamp);
            
            console.log('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é:', referralInfo);
            return referralInfo;
        }
    };
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function init() {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ñ–æ—Ä–º
        setTimeout(() => {
            processAllForms();
        }, 1000);
        
        // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –ø–æ–∑–∂–µ
        setTimeout(() => {
            processAllForms();
        }, 3000);
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    console.log('üìã –°–∫—Ä–∏–ø—Ç —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    console.log('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: TildaReferralHelper.showReferralInfo() –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö');
    console.log('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: TildaReferralHelper.addToForm("form") –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–æ—Ä–º–µ');
})();
</script>