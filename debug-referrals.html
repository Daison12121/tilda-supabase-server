<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px;
            background: #f9f9f9;
        }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #2196F3; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è kuvaldakg777@gmail.com</h1>
    
    <button onclick="debugUser()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <button onclick="checkCurrentUser()">üë§ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
    <button onclick="checkAllUsers()">üë• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
    
    <div id="results"></div>

    <script>
        const SERVER_URL = 'https://tilda-supabase-server-nodejs-20.up.railway.app';
        const TEST_EMAIL = 'kuvaldakg777@gmail.com';
        
        async function debugUser() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>';
            
            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', TEST_EMAIL);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ /user-full-data —Å email
                const response = await fetch(`${SERVER_URL}/user-full-data?email=${encodeURIComponent(TEST_EMAIL)}`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
                
                let html = '<div class="debug-section">';
                html += '<h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ /user-full-data</h3>';
                
                if (!data.success) {
                    html += `<p class="error">‚ùå –û—à–∏–±–∫–∞: ${data.message}</p>`;
                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    resultsDiv.innerHTML = html + '</div>';
                    return;
                }
                
                if (!data.user) {
                    html += '<p class="error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
                    resultsDiv.innerHTML = html + '</div>';
                    return;
                }
                
                const user = data.user;
                
                html += `<p class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: ${user.name} (${user.email})</p>`;
                html += `<p><strong>ID:</strong> ${user.id}</p>`;
                html += `<p><strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</strong> ${user.referral_code}</p>`;
                html += `<p><strong>–ü—Ä–∏–≥–ª–∞—à–µ–Ω:</strong> ${user.referred_by || '–ù–µ—Ç'}</p>`;
                html += '</div>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                html += '<div class="debug-section">';
                html += '<h3>üî¢ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã users)</h3>';
                html += `<p><strong>level_1_referrals:</strong> ${user.level_1_referrals || 0}</p>`;
                html += `<p><strong>level_2_referrals:</strong> ${user.level_2_referrals || 0}</p>`;
                html += `<p><strong>level_3_referrals:</strong> ${user.level_3_referrals || 0}</p>`;
                html += '</div>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—Å–∏–≤ referral_history
                html += '<div class="debug-section">';
                html += '<h3>üìú –ú–∞—Å—Å–∏–≤ referral_history</h3>';
                
                if (!user.referral_history || !Array.isArray(user.referral_history)) {
                    html += '<p class="warning">‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ referral_history –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º</p>';
                    html += `<p>–¢–∏–ø: ${typeof user.referral_history}</p>`;
                    html += `<p>–ó–Ω–∞—á–µ–Ω–∏–µ: ${JSON.stringify(user.referral_history)}</p>`;
                } else if (user.referral_history.length === 0) {
                    html += '<p class="warning">‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ referral_history –ø—É—Å—Ç–æ–π</p>';
                } else {
                    html += `<p class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –≤ referral_history: ${user.referral_history.length}</p>`;
                    
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—è–º
                    const level1 = user.referral_history.filter(ref => ref.level === 1);
                    const level2 = user.referral_history.filter(ref => ref.level === 2);
                    const level3 = user.referral_history.filter(ref => ref.level === 3);
                    
                    html += `<p><strong>–†–µ—Ñ–µ—Ä–∞–ª—ã 1 —É—Ä–æ–≤–Ω—è:</strong> ${level1.length}</p>`;
                    html += `<p><strong>–†–µ—Ñ–µ—Ä–∞–ª—ã 2 —É—Ä–æ–≤–Ω—è:</strong> ${level2.length}</p>`;
                    html += `<p><strong>–†–µ—Ñ–µ—Ä–∞–ª—ã 3 —É—Ä–æ–≤–Ω—è:</strong> ${level3.length}</p>`;
                    
                    if (level1.length > 0) {
                        html += '<h4>üë• –†–µ—Ñ–µ—Ä–∞–ª—ã 1 —É—Ä–æ–≤–Ω—è:</h4>';
                        level1.forEach((ref, index) => {
                            html += `<div style="background: white; padding: 10px; margin: 5px 0; border-radius: 4px;">`;
                            html += `<strong>${index + 1}.</strong> ${ref.user_name} (${ref.user_email})<br>`;
                            html += `–°—É–º–º–∞: ${ref.amount} —Å–æ–º, –î–∞—Ç–∞: ${ref.transaction_date}<br>`;
                            html += `–£—Ä–æ–≤–µ–Ω—å: ${ref.level}, –ö—É—Ä—Å: ${ref.course_id}`;
                            html += `</div>`;
                        });
                    }
                    
                    html += '<h4>üóÇÔ∏è –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ referral_history:</h4>';
                    html += `<pre>${JSON.stringify(user.referral_history, null, 2)}</pre>`;
                }
                html += '</div>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Å—Å–∏–≤ referral_transactions
                html += '<div class="debug-section">';
                html += '<h3>üí∞ –ú–∞—Å—Å–∏–≤ referral_transactions</h3>';
                
                if (!user.referral_transactions || !Array.isArray(user.referral_transactions)) {
                    html += '<p class="warning">‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ referral_transactions –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º</p>';
                } else if (user.referral_transactions.length === 0) {
                    html += '<p class="warning">‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ referral_transactions –ø—É—Å—Ç–æ–π</p>';
                } else {
                    html += `<p class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –≤ referral_transactions: ${user.referral_transactions.length}</p>`;
                    html += `<pre>${JSON.stringify(user.referral_transactions, null, 2)}</pre>`;
                }
                html += '</div>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                html += '<div class="debug-section">';
                html += '<h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>';
                
                if (!user.stats) {
                    html += '<p class="warning">‚ö†Ô∏è –û–±—ä–µ–∫—Ç stats –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>';
                } else {
                    html += `<p><strong>total_referral_earnings:</strong> ${user.stats.total_referral_earnings || 0}</p>`;
                    html += `<pre>${JSON.stringify(user.stats, null, 2)}</pre>`;
                }
                html += '</div>';
                
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é getNestedValue
                html += '<div class="debug-section">';
                html += '<h3>üß™ –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ referrals_level_1.first_name</h3>';
                
                const testResult = getNestedValue(user, 'referrals_level_1.first_name');
                html += `<p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> "${testResult}"</p>`;
                
                const testCount = getNestedValue(user, 'referrals_level_1.count');
                html += `<p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (count):</strong> ${testCount}</p>`;
                
                const testNames = getNestedValue(user, 'referrals_level_1.names');
                html += `<p><strong>–í—Å–µ –∏–º–µ–Ω–∞ (names):</strong> "${testNames}"</p>`;
                
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                resultsDiv.innerHTML = `<div class="debug-section"><p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p></div>`;
            }
        }
        
        async function checkCurrentUser() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...</p>';
            
            try {
                const response = await fetch(`${SERVER_URL}/user-full-data`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', data);
                
                let html = '<div class="debug-section">';
                html += '<h3>üë§ –¢–µ–∫—É—â–∏–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>';
                
                if (data.success && data.user) {
                    html += `<p class="success">‚úÖ ${data.user.name} (${data.user.email})</p>`;
                } else {
                    html += `<p class="error">‚ùå ${data.message}</p>`;
                }
                
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="debug-section"><p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p></div>`;
            }
        }
        
        async function checkAllUsers() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>';
            
            try {
                const response = await fetch(`${SERVER_URL}/get-all-users`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                console.log('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', data);
                
                let html = '<div class="debug-section">';
                html += '<h3>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</h3>';
                
                if (data.success && data.users) {
                    html += `<p class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.users.length}</p>`;
                    
                    data.users.forEach((user, index) => {
                        html += `<div style="background: white; padding: 10px; margin: 5px 0; border-radius: 4px;">`;
                        html += `<strong>${index + 1}.</strong> ${user.name} (${user.email})<br>`;
                        html += `–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ${user.referral_code}<br>`;
                        html += `–†–µ—Ñ–µ—Ä–∞–ª—ã: L1=${user.level_1_referrals || 0}, L2=${user.level_2_referrals || 0}, L3=${user.level_3_referrals || 0}`;
                        html += `</div>`;
                    });
                } else {
                    html += `<p class="error">‚ùå ${data.message}</p>`;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="debug-section"><p class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p></div>`;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–∫–æ–ø–∏—è –∏–∑ user-display.html)
        function getNestedValue(obj, path) {
            try {
                console.log('üîç getNestedValue –≤—ã–∑–≤–∞–Ω–∞ —Å:', { path, obj: obj });
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º
                if (path.startsWith('referrals_level_')) {
                    const level = parseInt(path.split('_')[2]); // referrals_level_1 -> 1
                    const field = path.split('.')[1]; // referrals_level_1.first_name -> first_name
                    
                    console.log('üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º referrals_level_:', { level, field });
                    
                    if (obj.referral_history && Array.isArray(obj.referral_history)) {
                        console.log('üìú referral_history –Ω–∞–π–¥–µ–Ω:', obj.referral_history);
                        
                        const levelReferrals = obj.referral_history.filter(ref => ref.level === level);
                        console.log(`üîç –†–µ—Ñ–µ—Ä–∞–ª—ã ${level} —É—Ä–æ–≤–Ω—è:`, levelReferrals);
                        
                        if (levelReferrals.length > 0) {
                            if (field === 'count') return levelReferrals.length;
                            if (field === 'names') return levelReferrals.map(ref => ref.user_name).join(', ');
                            if (field === 'first_name') return levelReferrals[0].user_name;
                            if (field === 'first_email') return levelReferrals[0].user_email;
                            if (field === 'first_amount') return levelReferrals[0].amount;
                            if (field === 'first_date') return levelReferrals[0].transaction_date;
                            if (field === 'total_amount') return levelReferrals.reduce((sum, ref) => sum + parseFloat(ref.amount || 0), 0);
                        }
                    } else {
                        console.log('‚ö†Ô∏è referral_history –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤');
                    }
                    
                    const result = field === 'count' ? 0 : '–ù–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤';
                    console.log('üì§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                    return result;
                }
                
                return path.split('.').reduce((current, key) => {
                    if (current === null || current === undefined) {
                        return undefined;
                    }
                    
                    if (!isNaN(key) && Array.isArray(current)) {
                        const index = parseInt(key);
                        return current[index];
                    }
                    
                    return current[key];
                }, obj);
            } catch (error) {
                console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—É—Ç–∏ "${path}":`, error);
                return undefined;
            }
        }
    </script>
</body>
</html>