<!-- 
–ì–û–¢–û–í–´–ô –ö–û–î –î–õ–Ø –í–°–¢–ê–í–ö–ò –í TILDA
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –±–ª–æ–∫ T123 (HTML) –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ
-->

<script>
(function() {
    'use strict';
    
    const SERVER_URL = 'https://tilda-supabase-server-nodejs-20.up.railway.app';
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function getUserData(email) {
        try {
            console.log('üîç –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è email:', email);
            
            const response = await fetch(`${SERVER_URL}/get-user?email=${encodeURIComponent(email)}`, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
            
            return data;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            return null;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    function fillFormFields(userData) {
        if (!userData || !userData.user) {
            console.log('‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            return;
        }
        
        const user = userData.user;
        console.log('üìù –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã:', user);
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø–æ –∏—Ö name, id –∏–ª–∏ placeholder
        const fieldsMap = {
            'name': user.name || user.full_name || user.first_name || '',
            'phone': user.phone || user.telephone || '',
            'email': user.email || '',
            'company': user.company || '',
            'position': user.position || user.job_title || ''
        };
        
        Object.keys(fieldsMap).forEach(fieldName => {
            if (!fieldsMap[fieldName]) return;
            
            // –ò—â–µ–º –ø–æ–ª–µ –ø–æ —Ä–∞–∑–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º
            const selectors = [
                `input[name="${fieldName}"]`,
                `input[id="${fieldName}"]`,
                `input[placeholder*="${fieldName}"]`,
                `textarea[name="${fieldName}"]`,
                `textarea[id="${fieldName}"]`
            ];
            
            for (const selector of selectors) {
                const field = document.querySelector(selector);
                if (field && !field.value) {
                    field.value = fieldsMap[fieldName];
                    console.log(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ ${fieldName}:`, fieldsMap[fieldName]);
                    
                    // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Tilda
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    break;
                }
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Tilda
    function checkTildaAuth() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Tilda
        const sources = [
            () => localStorage.getItem('tildaUser'),
            () => localStorage.getItem('tilda_user'),
            () => localStorage.getItem('tilda_member'),
            () => getCookie('tilda_user'),
            () => getCookie('tilda_member'),
            () => getCookie('tildaUser')
        ];
        
        for (const getSource of sources) {
            try {
                const userData = getSource();
                if (userData) {
                    const parsed = JSON.parse(userData);
                    if (parsed && parsed.email) {
                        console.log('üë§ –ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Tilda:', parsed.email);
                        return parsed.email;
                    }
                }
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
            }
        }
        
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Tilda
    function setupTildaAuthListener() {
        // –°–æ–±—ã—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã —á–ª–µ–Ω—Å—Ç–≤–∞ Tilda
        const events = ['tilda:member:login', 'tilda:member:register', 'tilda:auth:success'];
        
        events.forEach(eventName => {
            window.addEventListener(eventName, function(event) {
                console.log(`üéâ –°–æ–±—ã—Ç–∏–µ ${eventName}:`, event);
                if (event.detail && event.detail.email) {
                    setTimeout(() => {
                        getUserData(event.detail.email).then(fillFormFields);
                    }, 500);
                }
            });
        });
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–æ–ª—è—Ö email
    function setupEmailListener() {
        document.addEventListener('input', function(event) {
            if (event.target.type === 'email' && event.target.value.includes('@')) {
                const email = event.target.value.trim();
                if (email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                    console.log('üìß –û–±–Ω–∞—Ä—É–∂–µ–Ω –≤–≤–æ–¥ email:', email);
                    
                    clearTimeout(window.emailTimeout);
                    window.emailTimeout = setTimeout(() => {
                        getUserData(email).then(fillFormFields);
                    }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫—É–Ω–¥—ã
                }
            }
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function checkOnLoad() {
        const email = checkTildaAuth();
        if (email) {
            getUserData(email).then(fillFormFields);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Tilda-Supabase...');
        
        setupTildaAuthListener();
        setupEmailListener();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(checkOnLoad, 1000);
            });
        } else {
            setTimeout(checkOnLoad, 1000);
        }
        
        console.log('‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    window.getTildaUserData = function(email) {
        if (!email) {
            email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:');
        }
        if (email) {
            getUserData(email).then(fillFormFields);
        }
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º
    init();
    
})();
</script>

<!-- –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) -->
<style>
.tilda-debug {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: #000;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 9999;
    max-width: 300px;
}
</style>

<!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) -->
<div class="tilda-debug" id="tilda-debug" style="display: none;">
    <strong>Tilda-Supabase Debug</strong><br>
    <button onclick="window.getTildaUserData()" style="margin-top: 5px;">–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</button><br>
    <button onclick="console.log('LocalStorage:', localStorage); console.log('Cookies:', document.cookie);" style="margin-top: 5px;">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button><br>
    <button onclick="document.getElementById('tilda-debug').style.display='none'" style="margin-top: 5px;">–°–∫—Ä—ã—Ç—å</button>
</div>

<!-- –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –ø–∞–Ω–µ–ª—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Ctrl+Shift+D -->
<script>
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const debug = document.getElementById('tilda-debug');
        debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
    }
});
</script>