# 🚀 Tilda + Supabase Auth System

Система авторизации и отображения данных пользователей для сайтов на Tilda с базой данных Supabase.

## 📋 Описание

Эта система позволяет:
- ✅ Перехватывать авторизацию на формах Tilda
- ✅ Автоматически отображать данные пользователя на страницах
- ✅ Синхронизировать сессии между страницами
- ✅ Работать без изменения стандартных форм Tilda

## 🏗️ Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Tilda Forms   │───▶│   Node.js API    │───▶│   Supabase DB   │
│  (auth-inter.)  │    │   (server.js)    │    │   (users table) │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Tilda Pages    │◀───│  Session Store   │◀───│  User Data API  │
│ (user-display)  │    │  (in memory)     │    │  (REST calls)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 📁 Структура проекта

```
tilda-supabase-server/
├── server.js                 # 🖥️  Основной сервер (Node.js + Express)
├── auth-interceptor.html     # 🔐 Код для страницы авторизации
├── user-display.html        # 👤 Код для отображения данных пользователя
├── test-auth.html           # 🧪 Страница для тестирования системы
├── package.json             # 📦 Зависимости проекта
├── .env                     # 🔑 Переменные окружения (Supabase)
└── README.md               # 📖 Документация
```

## 🚀 Быстрый старт

### 1. Настройка сервера

Сервер уже развернут на Railway: `https://tilda-supabase-server-nodejs-20.up.railway.app`

### 2. Настройка авторизации

1. **Скопируйте код из `auth-interceptor.html`**
2. **Вставьте в блок T123 на странице авторизации Tilda**
3. **Опубликуйте страницу**

### 3. Настройка отображения данных

1. **Создайте Zero Block с элементами:**
   ```html
   <div class="t-name">Имя пользователя</div>
   <div class="t-email">Email пользователя</div>
   <div class="t-phone">Телефон пользователя</div>
   ```

2. **Скопируйте код из `user-display.html`**
3. **Вставьте в блок T123 на странице с данными**
4. **Опубликуйте страницу**

## 🎯 API Endpoints

### `POST /auth-sync`
Синхронизация авторизации пользователя
```javascript
{
  "email": "user@example.com",
  "action": "login",
  "timestamp": "2024-01-01T12:00:00Z",
  "source": "tilda_form",
  "page": "https://example.com/login"
}
```

### `GET /current-user`
Получение текущего авторизованного пользователя
```javascript
{
  "success": true,
  "user": {
    "email": "user@example.com",
    "name": "Имя Пользователя",
    "phone": "+996123456789"
  }
}
```

### `GET /get-user?email=user@example.com`
Получение пользователя по email
```javascript
{
  "success": true,
  "user": {
    "email": "user@example.com",
    "name": "Имя Пользователя",
    "phone": "+996123456789"
  }
}
```

## 🔧 Настройка элементов

В файле `user-display.html` настройте селекторы элементов:

```javascript
const USER_ELEMENTS = {
    '#rec1235790536 .t-name': 'name',           // Имя пользователя
    '#rec1235790536 .t-email': 'email',         // Email пользователя  
    '#rec1235790536 .t-phone': 'phone',         // Телефон пользователя
    '#rec1235790536 .t-company': 'company',     // Компания
    '#rec1235790536 .t-position': 'position',   // Должность
    
    // Добавьте свои селекторы:
    // '.user-name': 'name',
    // '.user-info': 'email',
    // '[data-user="name"]': 'name',
};
```

## 🧪 Отладка

### Для страницы авторизации:
- Нажмите **Ctrl+Shift+A** для открытия отладочной панели
- Используйте кнопки для тестирования перехвата форм

### Для страницы отображения данных:
- Нажмите **Ctrl+Shift+U** для открытия отладочной панели
- Используйте кнопки для тестирования загрузки данных

## 🗄️ База данных

Структура таблицы `users` в Supabase:

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    phone VARCHAR(50),
    company VARCHAR(255),
    position VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 🔒 Безопасность

- ✅ CORS настроен для работы с доменами Tilda
- ✅ Валидация email адресов
- ✅ Защита от SQL инъекций через Supabase
- ✅ Сессии хранятся в памяти сервера (не в cookies)

## 🚨 Устранение неполадок

### Проблема: Данные не отображаются
1. Проверьте селекторы в `USER_ELEMENTS`
2. Убедитесь, что пользователь авторизован
3. Откройте консоль браузера (F12) для просмотра ошибок

### Проблема: Авторизация не работает
1. Проверьте, что код вставлен в блок T123
2. Убедитесь, что форма имеет поле email
3. Проверьте консоль браузера на ошибки

### Проблема: Сервер недоступен
1. Проверьте статус Railway: https://railway.app
2. Убедитесь, что URL сервера корректный
3. Проверьте настройки CORS

## 📞 Поддержка

Для получения помощи:
1. Откройте консоль браузера (F12)
2. Найдите сообщения с префиксами 🔐, 👤, ✅, ❌
3. Используйте отладочные панели (Ctrl+Shift+A/U)

## 🔄 Обновления

Система автоматически обновляет данные каждые 30 секунд и поддерживает:
- ✅ Автоматическое восстановление соединения
- ✅ Кеширование данных пользователя
- ✅ Индикаторы загрузки и ошибок
- ✅ Периодическую синхронизацию

---

**Версия:** 2.0  
**Статус:** ✅ Готово к использованию  
**Сервер:** https://tilda-supabase-server-nodejs-20.up.railway.app